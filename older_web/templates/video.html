{%extends "layout.html" %}
<!-- 导航标记 -->
{% block video %}active{% endblock %}
{% block current-page %}视频管理{% endblock %}
<!-- 内容区 -->
{% block mainbody %}
{% verbatim %}
<div id="app" class="container">
  <div class="content-wrapper">
    <div class="filter-container">
      <div class="filter-item" style="width: 110px;">
        <el-select v-model="queryData.cate_id" clearable placeholder="分类" @change="searchList">
          <el-option v-for="item in cateOptions" :key="item.id" :label="item.name" :value="item.id"></el-option>
        </el-select>
      </div>
      <div class="filter-item">
        <el-button class="filter-item" type="primary" icon="el-icon-plus" @click="onAdd">添加</el-button>
        <el-button class="filter-item" type="warning" icon="el-icon-search" @click="searchList">查询</el-button>
      </div>
    </div>
    <el-table :data="list" style="width: 100%">
      <el-table-column prop="id" label="id" width="100"></el-table-column>
      <el-table-column prop="title" label="标题" width="100"></el-table-column>
      <el-table-column :formatter="formatterCate" prop="cate_id" label="分类" width="120" align="center"></el-table-column>
      <el-table-column prop="img_url" label="封面" width="200" align="center">
        <template slot-scope="{ row }">
          <img class="img-cell" style="max-width: 200px; max-height: 100px;" :src="row.img_url"/>
        </template>
      </el-table-column>
      <el-table-column prop="create_time" label="时间" width="100" align="center"></el-table-column>
      <el-table-column align="right" label="操作">
        <template slot-scope="{ row }">
          <el-button type="text" @click="onShowDetail(row)">详情</el-button>
        </template>
      </el-table-column>
    </el-table>
  </div>
  <!-- 表单 -->
  <el-dialog :visible.sync="showAddForm" :title="formTitleMap[addFormType]">
    <el-form ref="addForm" :model="addInfo" :rules="addRules" :disabled="addFormType == 1" label-width="90px" label-position="left" size="mini">
      <el-form-item label="标题" prop="title">
        <el-input v-model="addInfo.title"/>
      </el-form-item>
      <el-form-item label="分类" prop="cate_id">
        <el-select v-model="addInfo.cate_id" placeholder="请选择分类">
          <el-option v-for="item in cateOptions" :key="item.id" :label="item.name" :value="item.id"></el-option>
        </el-select>
      </el-form-item>
      <el-form-item v-if="addFormType == 0" label="封面" prop="img_url">
        <el-upload
          ref="uploadImg"
          :action="imgUploadForm.action"
          :data="imgUploadForm.data"
          :on-change="handleChangeImg"
          :on-remove="handleRemoveImg"
          :on-success="handleSuccessImg"
          :on-error="handleErrorImg"
          :file-list="imgFileList"
          :limit="1"
          multiple>
          <el-button size="mini" type="warning" icon="el-icon-rank">选择文件</el-button>
        </el-upload>
      </el-form-item>
      <el-form-item v-if="addFormType == 0" label="视频" prop="video_url">
        <el-upload
          ref="uploadVideo"
          :action="videoUploadForm.action"
          :data="videoUploadForm.data"
          :on-change="handleChangeVideo"
          :on-remove="handleRemoveVideo"
          :on-success="handleSuccessVideo"
          :on-error="handleErrorVideo"
          :file-list="videoFileList"
          :limit="1"
          multiple>
          <el-button size="mini" type="warning" icon="el-icon-rank">选择文件</el-button>
        </el-upload>
      </el-form-item>
      <el-form-item label="文本内容" prop="content">
        <el-input type="textarea" autosize placeholder="请输入文本内容" v-model="addInfo.content"></el-input>
      </el-form-item>
      <div style="text-align: right;">
        <el-button v-if="!addFormType" type="primary" @click="onSubmit">添加</el-button>
      </div>
    </el-form>
  </el-dialog>
</div>
{% endverbatim %}
<script>
  let id = 0;
  new Vue({
    el: '#app',
    data() {
      return {
        // 查询
        queryData: {
          cate_id: ''
        },
        // 分页
        page: {
          page_index: 1,
          page_size: 10,
          total_count: 0
        },
        list: [],
        // 分类列表
        cateOptions: [],
        // 添加表单
        formTitleMap: ['添加视频', '视频详情'],
        showAddForm: false,
        addFormType: 0, // 表单类型：0添加 1详情
        addInfo: {
          id: null, // id
          cate_id: null, // 分类
          title: null, // 标题
          content: null, // 文本内容
          img_url: null, // 封面地址
          video_url: null, // 视频地址
        },
        addRules: {
          cate_id: [{ required: true, message: '请选择分类', trigger: 'change' }],
          title: [{ required: true, message: '请输入标题', trigger: 'blur' }],
          content: [{ required: true, message: '请输入文本内容', trigger: 'blur' }],
          img_url: [{ required: true, message: '请上传封面', trigger: 'blur' }],
          video_url: [{ required: true, message: '请上传视频', trigger: 'blur' }],
        },
        // 封面上传
        imgFileList: [],
        imgUploadForm: {
          src: '',
          action: '/videoUploadImg',
          data: {},
          type: ['image/png', 'image/jpeg'],
          loading: false
        },
        // 视频上传
        videoFileList: [],
        videoUploadForm: {
          src: '',
          action: '/videoUploadVideo',
          data: {},
          type: ['video/mp4'],
          loading: false
        }
      }
    },
    mounted() {
      this.searchList()
      this.initCateDict()
    },
    methods: {
      // 查询视频列表
      searchList() {
        this.page = {
          page_index: 1,
          page_size: 10,
          total_count: 0
        }
        this.getList()
      },
      // 获取视频列表
      async getList() {
        const ret = await serverPost(ToDJ('videoList'), Object.assign({}, this.page, this.queryData))
        if (ret.code === 0) {
          const { list, total_count } = ret.data
          for (const item of list) {
            item.create_time = FormatDate(new Date(item.create_time))
            item.img_url = `../${item.img_url}`
          }
          console.log(list)
          this.page.total_count = total_count
          this.list = list
        } else {
          NotifyFail(this, ret.data)
        }
      },
      // 提交表单
      onSubmit() {
        // 检查输入
        this.$refs.addForm.validate(async (valid) => {
          if (valid) {
            // // 图片上传
            // this.$refs.uploadImg.submit()
            // // 视频上传
            // this.$refs.uploadVideo.submit()
            this.onDoAdd()
          }
        })
      },
      // 向后端发送添加指令
      async onDoAdd() {
        let { cate_id, title, content, img_url, video_url } = this.addInfo
        const para = {
          cate_id, title, content, img_url, video_url
        }
        const ret = await serverPost(ToDJ('videoAdd'), para)
        if (ret.code === 0) {
          this.showAddForm = false
          this.searchList()
        } else {
          NotifyFail(this, ret.data)
        }
      },
      // 添加
      onAdd() {
        this.addInfo = {
          id: null, // id
          cate_id: null, // 分类
          title: null, // 标题
          content: null, // 文本内容
          img_url: null, // 封面地址
          video_url: null, // 视频地址
        }
        this.imgFileList = []
        this.videoFileList = []
        this.addFormType = 0
        this.showAddForm = true
      },
      // 显示详情
      onShowDetail(row) {
        console.log(row)
        const { id, cate_id, title, content, img_url, video_url } = row
        this.addInfo = {
          id, // id
          cate_id, // 分类
          title, // 标题
          content, // 文本内容
          img_url, // 封面地址
          video_url, // 视频地址
        }
        this.addFormType = 1
        this.showAddForm = true
      },
      // 格式化显示分类
      formatterCate(row, column, cellValue, index) {
        let name = ''
        for (const item of this.cateOptions) {
          if (item.id == row.cate_id) {
            name = item.name
            break
          }
        }
        return name
      },
      // 初始化分类字典
      async initCateDict() {
        const ret = await serverPost(ToDJ('videoCateList'))
        if (ret.code === 0) {
          const { list } = ret.data
          this.cateOptions = list
        } else {
          NotifyFail(this, ret.data)
        }
      },
      // 上传监听方法
      // 封面
      handleChangeImg(file, fileList) {
        if (file.status === 'ready') {
          if (this.imgUploadForm.type.includes(file.raw.type)) {
            this.imgFileList = fileList
          } else {
            console.log('handleChangeImg：', file, fileList)
            NotifyFail(this, '请添加图片文件')
          }
        }
      },
      handleRemoveImg(file, fileList) {
        this.imgFileList = fileList
      },
      handleSuccessImg(res, file) {
        console.log(res)
        if (res.code == 0) {
          this.addInfo.img_url = res.data
        } else {
          NotifyFail(this, '封面上传失败')
        }
      },
      handleErrorImg(error, file) {
        NotifyFail(this, '封面上传失败')
        console.log('文件上传失败:', error, file)
      },
      // 视频
      handleChangeVideo(file, fileList) {
        if (file.status === 'ready') {
          if (this.videoUploadForm.type.includes(file.raw.type)) {
            this.videoFileList = fileList
          } else {
            console.log('handleChangeVideo', file, fileList)
            NotifyFail(this, '请添加视频文件')
          }
        }
      },
      handleRemoveVideo(file, fileList) {
        this.videoFileList = fileList
      },
      handleSuccessVideo(res, file) {
        if (res.code == 0) {
          this.addInfo.video_url = res.data
        } else {
          NotifyFail(this, '视频上传失败')
        }
      },
      handleErrorVideo(error, file) {
        NotifyFail(this, '视频上传失败')
        console.log('文件上传失败:', error, file)
      }
    }
  })
</script>
{% endblock %}